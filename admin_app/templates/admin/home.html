{% extends "base.html" %} {% block content %} {% include 'nav_menu.html' %}

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav
      class="col-md-3 col-lg-2 d-md-block sidebar collapse"
      style="
        background-color: #1c1f23;
        border-right: 1px solid #2c3036;
        height: 100vh;
      "
    >
      <div class="position-sticky pt-3" style="overflow-y: auto">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a
              class="nav-link text-light fw-bold"
              href="#"
              onclick="loadAdminSection('/admin/manage_users')"
            >
              <i class="bi bi-people me-2"></i> Manage Users
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-light fw-bold"
              href="#"
              onclick="loadAdminSection('/admin/tank_charts')"
            >
              <i class="bi bi-fuel-pump me-2"></i> Tank Charts
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-light fw-bold"
              href="#"
              onclick="loadAdminSection('/admin/store_info')"
            >
              <i class="bi bi-shop me-2"></i> Store Info
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-light fw-bold"
              href="#"
              onclick="loadAdminSection('/admin/upload_speedgauge')"
            >
              <i class="bi bi-speedometer2 me-2"></i> SpeedGauge Files
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div id="admin-main-content" class="pt-3">
        <h2 class="fw-bold">Admin Panel</h2>
        <p class="lead">
          Select an option from the left to begin managing system data.
        </p>
      </div>
    </main>
  </div>
</div>

<script>
  function loadAdminSection(route) {
    event.preventDefault();
    let contentArea = document.getElementById("admin-main-content");

    fetch(route)
      .then((response) => {
        if (!response.ok) throw new Error("Network response was not ok");
        return response.text();
      })
      .then((html) => {
        contentArea.innerHTML = html;
        // If the upload form was loaded, attach the submit handler
        const uploadForm = document.getElementById("speedgauge-upload-form");
        if (uploadForm) {
          uploadForm.addEventListener("submit", handleUploadSubmit);
        }
      })
      .catch((error) => {
        console.error("Error loading section:", error);
        contentArea.innerHTML = `<div class="alert alert-danger">Error loading content.</div>`;
      });
  }

  function handleUploadSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const contentArea = document.getElementById("admin-main-content");

    // Optional: Add a loading indicator
    contentArea.innerHTML = `<div class="d-flex justify-content-center align-items-center" style="height: 200px;"><div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div></div>`;

    fetch(form.action, {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json()) // Expect a JSON response from the server
      .then((data) => {
        if (data.message) {
          // On success, load the success view
          loadAdminSection("/admin/upload_success");
        } else {
          // On failure, display the error from the server
          contentArea.innerHTML = `<div class="alert alert-danger">${
            data.error || "An unknown error occurred."
          }</div>`;
        }
      })
      .catch((error) => {
        console.error("Error submitting form:", error);
        contentArea.innerHTML = `<div class="alert alert-danger">An error occurred while submitting the form.</div>`;
      });
  }
</script>

{% endblock %}
