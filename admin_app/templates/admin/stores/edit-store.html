{% extends "base.html" %} {% block content %}

<div class="container mt-4">
  <div class="mb-4 text-center">
    <!-- Page header -->
    <h1 class="text-light fw-bold mb-2">Edit Store</h1>

    <!-- Store name -->
    <h2 class="text-info fw-semibold mb-1">{{ store.store_name }}</h2>

    <!-- Store number / Riso number -->
    <p>{{ store.store_num }} / {{ store.riso_num }}</p>

    <hr class="border-secondary" />
  </div>

  <form
    method="POST"
    class="mt-4"
    action="{{ url_for('admin.submit_store_edit') }}"
  >
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input type="hidden" name="store_id" value="{{ store.id }}" />
    <input type="hidden" id="tanks-json" name="tanks_json" value="" />

    <div class="mb-3">
      <label for="store_num" class="form-label text-light">Store Number</label>
      <input
        type="number"
        class="form-control"
        id="store_num"
        name="store_num"
        value="{{ store.store_num }}"
        required
      />
    </div>

    <div class="mb-3">
      <label for="riso_num" class="form-label text-light">Riso Number</label>
      <input
        type="number"
        class="form-control"
        id="riso_num"
        name="riso_num"
        value="{{ store.riso_num }}"
        required
      />
    </div>

    <div class="mb-3">
      <label for="store_name" class="form-label text-light">Store Name</label>
      <input
        type="text"
        class="form-control"
        id="store_name"
        name="store_name"
        value="{{ store.store_name }}"
        required
      />
    </div>

    <div class="mb-3">
      <label for="store_type" class="form-label text-light">Store Type</label>
      <input
        type="text"
        class="form-control"
        id="store_type"
        name="store_type"
        value="{{ store.store_type }}"
      />
    </div>

    <div class="mb-3">
      <label for="address" class="form-label text-light">Address</label>
      <input
        type="text"
        class="form-control"
        id="address"
        name="address"
        value="{{ store.address }}"
      />
    </div>

    <div class="mb-3">
      <label for="city" class="form-label text-light">City</label>
      <input
        type="text"
        class="form-control"
        id="city"
        name="city"
        value="{{ store.city }}"
      />
    </div>

    <div class="mb-3">
      <label for="state" class="form-label text-light">State</label>
      <input
        type="text"
        class="form-control"
        id="state"
        name="state"
        value="{{ store.state }}"
      />
    </div>

    <div class="mb-3">
      <label for="zip" class="form-label text-light">Zip Code</label>
      <input
        type="number"
        class="form-control"
        id="zip"
        name="zip"
        value="{{ store.zip }}"
      />
    </div>

    <div class="mb-3">
      <label for="county" class="form-label text-light">County</label>
      <input
        type="text"
        class="form-control"
        id="county"
        name="county"
        value="{{ store.county }}"
      />
    </div>

    <div class="mb-3">
      <label for="lat" class="form-label text-light">Latitude</label>
      <input
        type="number"
        step="any"
        class="form-control"
        id="lat"
        name="lat"
        value="{{ store.lat }}"
      />
    </div>

    <div class="mb-3">
      <label for="lon" class="form-label text-light">Longitude</label>
      <input
        type="number"
        step="any"
        class="form-control"
        id="lon"
        name="lon"
        value="{{ store.lon }}"
      />
    </div>

    <div class="mb-3">
      <label for="install_date" class="form-label text-light"
        >Install Date</label
      >
      <input
        type="date"
        class="form-control"
        id="install_date"
        name="install_date"
        value="{{ store.install_date }}"
      />
    </div>

    <div class="mb-3">
      <label for="overfill_protection" class="form-label text-light"
        >Overfill Protection</label
      >
      <input
        type="text"
        class="form-control"
        id="overfill_protection"
        name="overfill_protection"
        value="{{ store.overfill_protection }}"
      />
    </div>

    <!-- Table wrapper -->
    <div id="tank-container" class="table-container"></div>
    <div class="mb-3">
      <button
        type="button"
        class="btn btn-success"
        data-bs-toggle="modal"
        data-bs-target="#addTankModal"
        onclick="openAddTankModal()"
      >
        Add Tank
      </button>
    </div>

    <button type="submit" class="btn btn-success">Save Changes</button>
    <a href="{{ url_for('admin.select_store') }}" class="btn btn-secondary"
      >Cancel</a
    >
  </form>
</div>

<!-- Add Tank Modal -->
<div class="modal fade" id="addTankModal" tabindex="-1" aria-labelledby="addTankModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTankModalLabel">Add Tank to Store</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <input type="text" id="tank-search-input" class="form-control" placeholder="Search tanks...">
        </div>
        <table class="table table-bordered table-dark text-light" id="available-tanks-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Capacity</th>
              <th>Max Depth</th>
              <th>Fuel Type</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- existing mapped tanks passed from Flask (store-specific mappings) -->
<script id="tanks-data" type="application/json">
  {{ tanks_list | tojson }}
</script>

{% endblock %}

{% block scripts %}
<script>
  // --------- State ----------
  const container = document.getElementById("tank-container");
  let tanks = JSON.parse(document.getElementById("tanks-data").textContent || "[]");
  let availableTanks = [];
  let availableFuelTypes = [];
  const addTankModal = new bootstrap.Modal(document.getElementById('addTankModal'));

  // --------- Rendering helpers ----------
  function createHeaderRow() {
    const tr = document.createElement("tr");
    tr.classList.add("text-light", "bg-dark");
    const headers = ["Delete", "Fuel Type", "Name", "Capacity", "Max Depth", "Misc Info", "Description"];
    headers.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      tr.appendChild(th);
    });
    return tr;
  }

  function renderTankRows(tbody, tanksArray) {
    tbody.innerHTML = "";
    for (let i = 0; i < tanksArray.length; i++) {
      const tank = tanksArray[i];
      const row = document.createElement("tr");
      if (tank.tank_id !== undefined) {
        row.dataset.tankId = tank.tank_id;
      }
      row.innerHTML = `
        <td style="width: 1%;">
          <button type="button" class="btn btn-danger btn-sm" onclick="deleteTank(${i})">Delete</button>
        </td>
        <td>${escapeHtml(tank.fuel_type || "")}<
        /td>
        <td>${escapeHtml(tank.name || "")}<
        /td>
        <td>${escapeHtml(tank.capacity !== undefined ? String(tank.capacity) : "")}<
        /td>
        <td>${escapeHtml(tank.max_depth !== undefined ? String(tank.max_depth) : "")}<
        /td>
        <td>${escapeHtml(tank.misc_info || "")}<
        /td>
        <td>${escapeHtml(tank.description || "")}<
        /td>
      `;
      tbody.appendChild(row);
    }
  }

  function renderTanks() {
    container.innerHTML = "";
    const table = document.createElement("table");
    table.className = "table table-bordered table-dark text-light";
    const thead = document.createElement("thead");
    thead.className = "table-secondary text-light";
    thead.appendChild(createHeaderRow());
    table.appendChild(thead);
    const tbody = document.createElement("tbody");
    renderTankRows(tbody, tanks);
    table.appendChild(tbody);
    container.appendChild(table);
  }

  function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return "";
    return String(unsafe).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#39;");
  }

  // --------- Actions ----------
  function deleteTank(index) {
    tanks.splice(index, 1);
    renderTanks();
  }

  function openAddTankModal() {
    fetch("/admin/api/get_tanks")
      .then(resp => resp.json())
      .then(data => {
        availableTanks = data.tank_list || [];
        availableFuelTypes = data.fuel_type_list || [];
        populateAvailableTanksTable(availableTanks);
      })
      .catch(err => console.error("Error fetching tanks:", err));
  }

  function populateAvailableTanksTable(tanksToDisplay) {
    const tableBody = document.querySelector("#available-tanks-table tbody");
    tableBody.innerHTML = "";
    tanksToDisplay.forEach(tank => {
      const row = document.createElement("tr");
      
      const fuelTypeSelect = document.createElement('select');
      fuelTypeSelect.className = 'form-select';
      availableFuelTypes.forEach(fuel => {
          const option = document.createElement('option');
          option.value = fuel;
          option.textContent = fuel;
          fuelTypeSelect.appendChild(option);
      });

      row.innerHTML = `
        <td>${escapeHtml(tank.name)}</td>
        <td>${escapeHtml(tank.capacity)}</td>
        <td>${escapeHtml(tank.max_depth)}</td>
      `;

      const fuelTd = document.createElement('td');
      fuelTd.appendChild(fuelTypeSelect);
      row.appendChild(fuelTd);

      const actionTd = document.createElement('td');
      const selectBtn = document.createElement('button');
      selectBtn.className = 'btn btn-primary btn-sm';
      selectBtn.textContent = 'Select';
      selectBtn.onclick = () => selectTankFromModal(tank, fuelTypeSelect.value);
      actionTd.appendChild(selectBtn);
      row.appendChild(actionTd);

      tableBody.appendChild(row);
    });
  }

  document.getElementById('tank-search-input').addEventListener('keyup', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filteredTanks = availableTanks.filter(tank => 
      tank.name.toLowerCase().includes(searchTerm) ||
      String(tank.capacity).includes(searchTerm) ||
      String(tank.max_depth).includes(searchTerm)
    );
    populateAvailableTanksTable(filteredTanks);
  });

  function selectTankFromModal(tank, fuelType) {
    if (!fuelType) {
        alert("Please select a fuel type.");
        return;
    }

    const newTank = {
      tank_id: tank.id,
      name: tank.name,
      fuel_type: fuelType,
      capacity: tank.capacity,
      max_depth: tank.max_depth,
      misc_info: tank.misc_info,
      description: tank.description,
    };

    tanks.push(newTank);
    renderTanks();
    addTankModal.hide();
  }

  // Initial render
  renderTanks();

  // Form submission logic
  const editForm = document.querySelector('form[action="{{ url_for("admin.submit_store_edit") }}"]');
  if (editForm) {
    editForm.addEventListener("submit", function (e) {
      const tanksInput = document.getElementById("tanks-json");
      if (tanksInput) {
        console.log("Submitting tanks:", tanks);
        const jsonString = JSON.stringify(tanks);
        console.log("JSON string:", jsonString);
        tanksInput.value = jsonString;
      }
    });
  }
</script>
{% endblock %}
