<div class="container mt-4">
  <h2>User Management</h2>
  <p>Search for users to view or edit their details.</p>

  <div class="card">
    <div class="card-header">Filter Users</div>
    <div class="card-body">
      <form id="user-search-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="row g-3">
          <div class="col-md-6">
            <label for="first_name" class="form-label">First Name</label>
            <input
              type="text"
              class="form-control"
              id="first_name"
              name="first_name"
              value="{{ request.form.first_name }}"
            />
          </div>
          <div class="col-md-6">
            <label for="last_name" class="form-label">Last Name</label>
            <input
              type="text"
              class="form-control"
              id="last_name"
              name="last_name"
              value="{{ request.form.last_name }}"
            />
          </div>
          <div class="col-md-4">
            <label for="driver_id" class="form-label">Driver ID</label>
            <input
              type="text"
              class="form-control"
              id="driver_id"
              name="driver_id"
              value="{{ request.form.driver_id }}"
            />
          </div>
          <div class="col-md-4">
            <label for="dot_number" class="form-label">DOT Number</label>
            <input
              type="text"
              class="form-control"
              id="dot_number"
              name="dot_number"
              value="{{ request.form.dot_number }}"
            />
          </div>
          <div class="col-md-4">
            <label for="role" class="form-label">Role</label>
            <input
              type="text"
              class="form-control"
              id="role"
              name="role"
              value="{{ request.form.role }}"
            />
          </div>
        </div>
        <button
          type="submit"
          class="btn btn-primary mt-3"
          onclick="submitUserForm(event)"
        >
          Search
        </button>
        <button type="reset" class="btn btn-secondary mt-3">Clear</button>
      </form>
    </div>
  </div>

  <div class="mt-4">
    <h3>User Results</h3>
    <div class="table-responsive" id="admin-main-content">
      <table class="table table-striped table-hover table-dark">
        <thead>
          <tr>
            <th>ID</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Username/Email</th>
            <th>Driver ID</th>
            <th>DOT Number</th>
            <th>Role</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if users %} {% for user in users %}
          <tr>
            <td>{{ user.id }}</td>
            <td>{{ user.first_name or '' }}</td>
            <td>{{ user.last_name or '' }}</td>
            <td>{{ user.username }}</td>
            <td>{{ user.driver_id or '' }}</td>
            <td>{{ user.dot_number or '' }}</td>
            <td>{{ user.role }}</td>
            <td>
              <button
                class="btn btn-sm btn-secondary"
                user_id="{{ user.id }}"
                onclick="loadEditForm(event)"
              >
                Edit
              </button>
            </td>
          </tr>
          {% endfor %} {% else %}
          <tr>
            <td colspan="8" class="text-center">No users found.</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  async function loadEditForm(event) {
    // get the userId from the button event
    let userId = event.target.getAttribute("user_id");

    // set the url to submit this POST request to
    let editUserUrl = "{{ url_for('admin.edit_user') }}";

    let formData = new FormData();
    formData.append("user_id", userId);
    formData.append("csrf_token", "{{ csrf_token() }}");

    let response = await fetch(editUserUrl, {
      method: "POST",
      body: formData,
    });

    let html = await response.text();
    let contentArea = document.getElementById("admin-main-content");
    contentArea.innerHTML = html;

    // Re-run any scripts in new HTML
    Array.from(contentArea.querySelectorAll("script")).forEach((oldScript) => {
      let newScript = document.createElement("script");
      if (oldScript.textContent)
        newScript.appendChild(document.createTextNode(oldScript.textContent));
      oldScript.parentNode.replaceChild(newScript, oldScript);
    });
  }
</script>

<script>
  // Make function async so we can use await inside
  async function submitUserForm(event) {
    event.preventDefault();

    let form = document.getElementById("user-search-form");
    let contentArea = document.getElementById("admin-main-content");

    let formData = new FormData(form);
    formData.append("csrf_token", "{{ csrf_token() }}");

    try {
      let response = await fetch("{{ url_for('admin.manage_users') }}", {
        method: "POST",
        body: formData,
      });

      if (!response.ok) throw new Error("Network error");

      let html = await response.text();
      contentArea.innerHTML = html;

      // Re-run any scripts in new HTML
      Array.from(contentArea.querySelectorAll("script")).forEach(
        (oldScript) => {
          let newScript = document.createElement("script");
          if (oldScript.textContent)
            newScript.appendChild(
              document.createTextNode(oldScript.textContent)
            );
          oldScript.parentNode.replaceChild(newScript, oldScript);
        }
      );
    } catch (err) {
      console.error("Error submitting form:", err);
      contentArea.innerHTML =
        "<p class='text-danger'>Error loading results</p>";
    }
  }
</script>
