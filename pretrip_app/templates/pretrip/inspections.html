{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Pretrip Inspection History</h2>
    <hr>

    {% if inspections %}
    <table class="table table-dark table-hover">
        <thead>
            <tr>
                <th scope="col">Date/Time</th>
                <th scope="col">Template</th>
                <th scope="col">Equipment</th>
                <th scope="col">Summary</th>
                <th scope="col">Status</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for inspection in inspections %}
            <tr>
                <td>{{ inspection.date.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ inspection.template_name }}</td>
                <td>{{ inspection.equipment }}</td>
                <td>{{ inspection.passed_items }} Passed, {{ inspection.failed_items }} Failed</td>
                <td>
                    {% if inspection.overall_status == 'OK' %}
                        <span class="badge bg-success">OK</span>
                    {% elif inspection.overall_status == 'Defects Found' %}
                        <span class="badge bg-warning text-dark">Defects Found</span>
                    {% elif inspection.overall_status == 'Action Required' %}
                        <span class="badge bg-danger">Action Required</span>
                    {% else %}
                        <span class="badge bg-secondary">N/A</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('pretrip.view_inspection', inspection_id=inspection.id) }}" class="btn btn-info btn-sm me-2">View Details</a>
                    <button type="button" class="btn btn-danger btn-sm" id="deleteBtn_{{ inspection.id }}" onclick="deleteInspection(event, {{ inspection.id }})">
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span>
                        <span class="button-text">Delete</span>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-info" role="alert">
        No pretrip inspections found.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    function deleteInspection(event, inspectionId) {
        if (confirm('Are you sure you want to delete this inspection?')) {
            const button = event.currentTarget;
            const spinner = button.querySelector('.spinner-border');
            const buttonText = button.querySelector('.button-text');

            // Disable all relevant buttons
            const allDeleteButtons = document.querySelectorAll('.btn-danger');
            const allViewButtons = document.querySelectorAll('.btn-info');
            allDeleteButtons.forEach(btn => btn.disabled = true);
            allViewButtons.forEach(btn => btn.disabled = true);

            button.disabled = true; // Ensure the clicked button is also disabled
            spinner.style.display = 'inline-block';
            buttonText.textContent = 'Deleting...';

            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            fetch(`/pretrip/api/pretrip/inspection/delete/${inspectionId}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({}) // Send an empty JSON body
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    window.location.reload(); // Reload page to reflect deletion
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the inspection.');
            });
        }
    }
</script>
{% endblock %}