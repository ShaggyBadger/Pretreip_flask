{% extends "base.html" %} {% block content %} {% include 'nav_menu.html' %}

<div class="container">
  <h1 class="text-center fw-bold display-4 mb-5">Tank Delivery Planning</h1>
  <h5 class="text-center fw-bold display-4 mb-5">{{ store_num }}</h5>

  <div id="tank-cards"></div>
</div>

<script>
  const tanks = JSON.parse(`{{ tanks | tojson | safe }}`);
  const csrfToken = document
    .querySelector('meta[name="csrf-token"]')
    .getAttribute("content");

  function renderTankCards(tanks) {
    const container = document.getElementById("tank-cards");

    tanks.forEach((tank, index) => {
      const card = document.createElement("div");
      card.className = "card shadow-sm p-4 mb-4";

      card.innerHTML = `
  <h5>Fuel Type: ${tank.fuel_type}</h5>
  <p>Max Capacity: ${tank.max_gal} gallons</p>
  <p>90% Capacity: ${tank.ninety_percent} gallons</p>

  <div class="row align-items-center mb-3">
    <!-- Input column -->
    <div class="col-md-8">
      <label for="gallons-${index}" class="form-label">Enter delivery gallons:</label>
      <input type="number" id="gallons-${index}" class="form-control" placeholder="e.g. 4600">
    </div>

    <!-- Result column -->
    <div class="col-md-4 text-center">
      <div id="result-${index}" class="fw-bold mono"
           style="font-size: 1.8rem; color: #28a745;">
        <!-- Result shows here -->
      </div>
    </div>
  </div>

  <button id="calc-btn-${index}" class="btn btn-primary mb-3">Calculate Max Inches</button>
`;

      container.appendChild(card);

      // Listen for button click
      document
        .getElementById(`calc-btn-${index}`)
        .addEventListener("click", function () {
          const gallons = parseFloat(
            document.getElementById(`gallons-${index}`).value
          );

          if (isNaN(gallons)) return alert("Please enter a valid number.");

          // ðŸ”¥ Send Ajax (fetch) to Flask
          fetch("/tankgauge/calculate_inches", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken, // Flask-WTF looks for this
            },
            body: JSON.stringify({
              gallons: gallons,
              tank_type_id: tank.tank_type_id, // send the tank_type_id
              max_gal: tank.max_gal,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              const result = document.getElementById(`result-${index}`);
              if (data.inches !== null) {
                result.textContent = `Max Inches: ${data.inch}"`;
              } else {
                result.textContent = `Too many gallons!`;
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });
    });
  }

  renderTankCards(tanks);
</script>

{% endblock %}
