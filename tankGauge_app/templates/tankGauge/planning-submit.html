{% extends "base.html" %} {% block content %} {% include 'nav_menu.html' %}
<style>
  .chart-container {
    width: 100%;
    aspect-ratio: 16 / 9; /* adjusts height based on width */
    max-height: 500px; /* optional cap on very large screens */
    min-height: 180px; /* optional floor for very small screens */
    position: relative; /* Chart.js will fill this */
  }

  .chart-container canvas {
    width: 100% !important;
    height: 100% !important;
    display: block;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="container">
  <h1 class="text-center fw-bold display-4 mb-5">Tank Delivery Planning</h1>
  <h5 class="text-center fw-bold display-4 mb-5">{{ store_num }}</h5>

  <div id="tank-cards"></div>
</div>
<script>
  async function generate_chart(tank_id, containerId, targetInch) {
    try {
      let response = await fetch("/tankgauge/get-tank-chart-info", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({ tank_id: tank_id }),
      });

      if (!response.ok) throw new Error("Network response was not ok");

      let chartData = await response.json();

      let container = document.getElementById(containerId);
      container.classList.add("chart-container");
      container.innerHTML = ""; // clear existing
      const canvas = document.createElement("canvas");
      container.appendChild(canvas);

      // Main dataset
      const datasets = [
        {
          label: "Gallons per Inch",
          data: chartData.map((row) => ({ x: row.inches, y: row.gallons })),
          borderColor: "#007bff",
          backgroundColor: "rgba(0,123,255,0.1)",
          fill: true,
          tension: 0.2,
        },
      ];

      // Add red dot for target inch
      if (targetInch !== null) {
        const match = chartData.find((row) => row.inches === targetInch);
        if (match) {
          datasets.push({
            label: `Measured Inch: ${targetInch}`,
            data: [{ x: match.inches, y: match.gallons }],
            borderColor: "red",
            backgroundColor: "red",
            pointRadius: 6,
            type: "scatter",
            showLine: false,
          });
        }
      }

      new Chart(canvas.getContext("2d"), {
        type: "line",
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: "bottom",
            },
          },
          scales: {
            x: {
              type: "linear",
              title: {
                display: true,
                text: "Inches",
              },
            },
            y: {
              title: {
                display: true,
                text: "Gallons",
              },
            },
          },
        },
      });
    } catch (error) {
      console.error("Error generating chart:", error);
    }
  }
</script>

<script>
  const tanks = JSON.parse(`{{ tanks | tojson | safe }}`);
  const csrfToken = document
    .querySelector('meta[name="csrf-token"]')
    .getAttribute("content");

  function renderTankCards(tanks) {
    const container = document.getElementById("tank-cards");

    tanks.forEach((tank, index) => {
      const card = document.createElement("div");
      card.className = "card shadow-sm p-4 mb-4";

      card.innerHTML = `
      <h5>Fuel Type: ${tank.fuel_type}</h5>
      <p>Max Capacity: ${tank.max_gal} gallons</p>
      <p>90% Capacity: ${tank.ninety_percent} gallons</p>

      <div class="row align-items-center mb-3">
        <!-- Input column -->
        <div class="col-md-8">
          <label for="gallons-${index}" class="form-label">Enter delivery gallons:</label>
          <input type="number" id="gallons-${index}" class="form-control" placeholder="e.g. 4600">
        </div>

        <!-- Result column -->
        <div class="col-md-4 text-center">
          <div id="result-${index}" class="fw-bold mono"
               style="font-size: 1.8rem; color: #28a745;">
            <!-- Result shows here -->
          </div>
          <div id="chart-div-${index}"></div>
        </div>
      </div>
      <button id="calc-btn-${index}" class="btn btn-primary mb-3">Calculate Max Inches</button>
    `;

      container.appendChild(card);

      // Listen for button click
      document
        .getElementById(`calc-btn-${index}`)
        .addEventListener("click", function () {
          const gallons = parseFloat(
            document.getElementById(`gallons-${index}`).value
          );

          if (isNaN(gallons)) return alert("Please enter a valid number.");

          // Send Ajax (fetch) to Flask
          fetch("/tankgauge/calculate_inches", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken, // Flask-WTF looks for this
            },
            body: JSON.stringify({
              gallons: gallons,
              tank_type_id: tank.tank_type_id, // send the tank_type_id
              max_gal: tank.max_gal,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              const result = document.getElementById(`result-${index}`);
              const chart_div = document.getElementById(`chart-div-${index}`);
              if (data.inches !== null) {
                result.textContent = `Max Inches: ${data.inch}"`;
              } else {
                result.textContent = `Too many gallons!`;
              }
              generate_chart(tank.tank_type_id, chart_div.id, data.inch);
            })

            .catch((error) => {
              console.error("Error:", error);
            });
        });
    });
  }
  renderTankCards(tanks);
  //loadTankData();
</script>

{% endblock %}
